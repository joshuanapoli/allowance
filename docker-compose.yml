version: "3.3"
services:
  bitcoin-core:
    ports:
      - "8333:8333"
    container_name: bitcoin-core
    image: ruimarinho/bitcoin-core
    restart: always
    volumes:
      - ./bitcoin:/home/bitcoin/.bitcoin
    networks:
      bitcoin:
        ipv4_address: 172.18.0.2
    command:
      - "-prune=${PRUNE:-550}"
      - "-rpcbind=127.0.0.1"
      - "-rpcallowip=127.0.0.1"
      - "-rpcbind=172.18.0.2"
      - "-rpcallowip=172.18.0.0/16"
      - "-rpcauth=${RPCAUTH:?use rpcauth.py to create a password and set the RPCPASS in .env}"
      - "-zmqpubrawblock=tcp://172.18.0.2:28332"
      - "-zmqpubrawtx=tcp://172.18.0.2:28333"
  lnd:
    ports:
      - "8080:8080"
      - "9735:9735"
      - "10009:10009"
    image: joshuanapoli/lnd:v0.14.1-beta # Same as https://hub.docker.com/r/lightninglabs/lnd plus Raspberry Pi support
    container_name: lnd
    depends_on:
      - bitcoin-core
    restart: always
    volumes:
      - ./lnd:/root/.lnd
    networks:
      bitcoin:
        ipv4_address: 172.18.1.1
    command:
      - "--bitcoin.active"
      - "--bitcoin.mainnet"
      - "--bitcoin.node=bitcoind"
      - "--bitcoind.rpcuser=${RPCUSER:-lnd}"
      - "--bitcoind.rpcpass=${RPCPASS:?use rpcauth.py to create a password and set the RPCPASS in .env}"
      - "--bitcoind.rpchost=bitcoin-core"
      - "--bitcoind.zmqpubrawblock=tcp://bitcoin-core:28332"
      - "--bitcoind.zmqpubrawtx=tcp://bitcoin-core:28333"
      - "--externalip=${EXTERNALIP}"
      - "--alias=${ALIAS}"
      - "--rpclisten=0.0.0.0:10009"
      - "--restlisten=0.0.0.0:8080"
      - "--tlsextradomain=${HOST}"
      - "--tlsextraip=172.18.1.1"
      - "--wallet-unlock-password-file=${WALLET_UNLOCK_PASSWORD_FILE}"
#  lightning-terminal:
#    ports:
#      - "80:80"
#      - "8443:8443"
#    image: joshuanapoli/lightning-terminal:v0.6.1-alpha
#    container_name: lightning-terminal
#    depends_on:
#      - lnd
#    restart: always
#    volumes:
#      - ./lightning-terminal:/root/.lightning-terminal
#      - ./lnd:/root/.lnd
#    networks:
#      bitcoin:
#        ipv4_address: 172.18.2.1
#    command:
#      - "--remote.lnd.rpcserver=172.18.1.1:10009"
#      - "--uipassword=${LITDPASS:?create a password and set the LITDPASS in .env}"
#      - "--httpslisten=0.0.0.0:8443"
#      - "--letsencrypt"
#      - "--letsencrypthost=${HOST}"
  thunderhub:
    ports:
      - "3000:3000"
    image: apotdevin/thunderhub:v0.12.31
    container_name: thunderhub
    depends_on:
      - lnd
    restart: always
    volumes:
      - ./lnd:/lnd
      - ./thunderhub:/data
    networks:
      bitcoin:
        ipv4_address: 172.18.3.1
    environment:
      COOKIE_PATH: "/data/.cookie"
      SSO_SERVER_URL: "172.18.1.1:10009"
      SSO_MACAROON_PATH: "/lnd/data/chain/bitcoin/mainnet/"
      SSO_CERT_PATH: "/lnd/tls.cert"

networks:
  bitcoin:
    ipam:
      config:
        - subnet: 172.18.0.0/16
